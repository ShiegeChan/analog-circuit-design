Suited with the knowledge of basic transitor operation (@sec-first-steps and @sec-gmid-method) and the working knowledge of the current mirror (@sec-mosfet-diode and @sec-current-mirror) as well as the differential pair (@sec-diff-pair) we can now start to design our first real circuit. A fundamental (simple) circuit that is often used for basic tasks is the 5-transistor operational transconductance amplifier (OTA). A circuit diagram of this 5T-OTA is shown in @fig-basic-ota.

{{< include figures/_fig_basic_ota.qmd >}}

The operation is as follows: $M_{1,2}$ form a differential pair which is biased by the current source $M_5$. $M_{5,6}$ form a current mirror, thus the input bias current $I_\mathrm{bias}$ sets the bias current in the OTA. The differential pair $M_{1,2}$ is loaded by the current mirror $M_{3,4}$ which mirrors the output current of $M_1$ to the right side. Here, the currents from $M_4$ and $M_2$ are summed, and together with the conductance effective at the output node a voltage builds up.

We note that $M_{1,2}$ and $M_{3,4}$ need to be symmetric, thus will have the same $W \& L$ dimensionsing. $M_{5,6}$ we scale accordingly to set the correct bias current in the OTA.

As this is an OTA the output is a current; if the load impedance is high (i.e., purely capacitive, which is often the case in integrated circuits when driving MOSFET inputs) then the voltage gain of the OTA can be high (of course, in this simple OTA it is limited). With a high-impedance loading this OTA can provide a voltage output, and this is actually how OTAs are mostly operated.

### Voltage Buffer with OTA

In order to design an OTA we need an application, and from this we need to derive the circuit specifications. We want to use this OTA to realize a voltage buffer which lighly loads a voltage source and can drive a large capacitive load. Such a configuration is often used to, e.g., buffer a reference voltage that is needed (and thus loaded) by another circuit. The block diagram of this configuration is shown in @fig-voltage-buffer-ota.

{{< include figures/_fig_voltage_buffer_ota.qmd >}}

If the voltage gain of the OTA is @fig-voltage-buffer-ota is high, then $V_\mathrm{out} \approx V_\mathrm{in}$. We now want to design an OTA for this application for the following spefication values (see @tbl-voltage-buffer-spec).

| Specification                                       | Value                              | Unit    |
|:----------------------------------------------------|:----------------------------------:|:-------:|
| Load capacitance $C_\mathrm{load}$                  | 50                                 | fF      |
| Input voltage range (for buffering bandgap voltage) | 1.1---1.3                          | V       |
| Signal bandwidth (3dB)                              | >1                                 | MHz     |
| Voltage gain error                                  | <5                                 | %       |
| Total output noise (rms)                            | <1                                 | mV~rms~ |
| Supply voltage                                      | 1.45---1.5---1.55                  | V       |
| Supply current (as low as possible)                 | <100                               | µA      |
| Stability                                           | stable for rated $C_\mathrm{load}$ |         |
| Turn-on time (settled to with 1%)                   | <10                                | µs      |
| Externally provided bias current (nominal)          | 20                                 | µA      |

: Voltage buffer specification {#tbl-voltage-buffer-spec}

### Large-Signal Analysis of the OTA {#sec-basic-ota-large-signal}

The first step when receiving a design task is to look at the specifications, and see whether they make sense. Detailed performance of the design will be the result of the circuit simulation, but before we step into sizing we need to do a few simple calculations to (a) allows to do back-of-the-envelope gauging if the specification makes sense, and (b) the derived analytical equations will serve as guide for the sizing procedure.

- In terms of large-signal operation, we will now check whether the input and output voltage range, as well as the settling time can be roughly met.
- When the input is at its maximum of $1.3\,\text{V}$, we see that we need to keep $M_1$ in saturation. We can calculate that $\VDS[1] = \VDD - |\VGS[3]| + \VGS[1] - V_\mathrm{in} = 1.45 - 0.6 + 0.6 - 1.3 = 0.15\,\text{V}$, which barely leaves enough margin, so we must keep the gate-source voltages of $M_1$ and $M_3$ resonably small.
- When the input is at its minimum of $1.1\,\text{V}$, we see that the $\VDS[5]$ of $M_5$ is calculated as $\VGS[5] = V_\mathrm{in} - \VGS[1] = 1.1 - 0.6 = 0.5\,\text{V}$, so this leaves plenty of margin.
- For the output voltage, when the output voltage is on the high side, it leaves $|\VDS[4]| = \VDD - V_\mathrm{out} = 1.45 - 1.3 = 0.15\,\text{V}$, whis is on the edge.
- When the output voltage is on the low side, it leaves $\VDS[2] = V_\mathrm{out} - V_\mathrm{in} + \VGS[2] = 1.3 - 1.55 + 0.6 = 0.35\,\text{V}$, so this should work.

In summary, we think that we can make an NMOS-input OTA like the one in @fig-basic-ota work for the required supply and input- and output voltages. If this would not work out, we need to look for further options, like a PMOS-input OTA, or a NMOS/PMOS-input OTA.

Another large-signal specification item that we can quickly check is the settling time. Under slewing conditions, we complete bias current in the OTA is steered towards the output (try to understand why this is the case), so when the output capacitor is fully discharged, and we assume just a linear ramp due to constant-current charging of the output capacitor, the settling time is
$$
T_\mathrm{slew} \approx \frac{C_\mathrm{load} V_\mathrm{out}}{I_\mathrm{tail}} = \frac{50 \cdot 10^{-15} \cdot 1.3}{100 \cdot 10^{-6}} = 0.65\,\text{ns}
$$
so this leaves plenty of margin for additional slow-signal settling due to the limited bandwidth, as well as reducing the supply current.

The small-signal settling (assuming one pole at the bandwidth corner frequency) leads to an approximate settling time (1% error corresponds to $\approx 5 \tau$) of
$$
T_\mathrm{slew} \approx \frac{5}{2 \pi f_\mathrm{c}} = \frac{5}{2 \pi \cdot 1 \cdot 10^{-6}} = 0.8\,\mu\text{s}.
$$
which also checks out.

### Small-Signal Analysis of the OTA {#sec-basic-ota-small-signal}

In order to size the OTA components we need to see derive how MOSFET parameters define the performance. The important small-signal metrics are

- dc gain $A_0$
- gain-bandwidth product (GBW)
- output noise

The specification for GBW is given in @tbl-voltage-buffer-spec, the dc gain we have to calculate from the voltage accuracy specification. For a voltage follower in the configuration shown in @fig-voltage-buffer-ota the voltage gain is given by
$$
\frac{V_\mathrm{out}}{V_\mathrm{in}} = \frac{A_0}{1 + A_0}.
$$

So in order to reach an output voltage accuracy of at least 5% we need a dc gain of $A_0 > 25.6\,\text{dB}$. To allow for process and temperature variation we will strive for $A_0 = 30\,\text{dB}$ 

### OTA Small-Signal Transfer Function

In order to derive the governing equations for the OTA we will make a few simplififcations:

- We will set $\gmb = 0$ for all MOSFET.
- We will further set $\Cgd = 0$ for all MOSFET except for $M_4$ where we expect a Miller effect on this capacitor, and we could add its effect by increasing the capacitance at the gate node of $M_{3,4}$. Hoewever, as this does not create a dominant pole in this circuit, we consider this a minor effect (see @eq-simple-ota-gain).
- We assume $\gm \gg \gds$, so we set $\gds[1] = \gds[3] = 0$.
- The drain capacitance of $M_2$ and $M_4$ we can add to the load capacitance $C_\mathrm{load}$.

The resulting small-signal equivalent circuit is shown in @fig-basic-ota-small-signal.

::: {.callout-note}
Please review the MOSFET small-signal equivalent model in @fig-mosfet-small-signal-model at this point. For the PMOS just flip the model upside-down.
:::

{{< include figures/_fig_basic_ota_small_signal.qmd >}}

We can further simplify the output side by recognizing that the impedance looking from the output down we have $\gds[2]$ in series with $\gds[5] + \gm[12]$ (since we treat $M_1$ as a common-gate stage when looking from the output, and since it is loaded by a low impedance of $\gm[34]^{-1}$ we can approximate the impedance looking into $M_1$ with $\gm[12]^{-1}$). With the approximation that $\gm \gg \gds$ we can move $\gds[2] + \gds[4]$ in parallel to $C_\mathrm{load}$. Further assuming a differential drive with a virtual ground at the tailpoint we can remove $\gds[5]$. The current source $\gm[34] \vgs[34]$ with replace with the equivalent conductance $\gm[34]$. This results in the further simplified equivalent circuit shown in @fig-basic-ota-small-signal-simplified.

::: {.callout-note}
For repetition and as a reference, here the simplified relationships for the common-source, common-gate, and the common-drain single transistor stages:

FIXME -- to be done
:::

{{< include figures/_fig_basic_ota_small_signal_simplified.qmd >}}

In the simplified circuit model in @fig-basic-ota-small-signal-simplified we can see that we have two poles in the circuit, one at the gate note of $M_{3,4}$, and one at the output. Realizing that $v_\mathrm{in,p} = v_\mathrm{in}/2$ and $v_\mathrm{in,n} = - v_\mathrm{in}/2$ we can formulate KCL at the output node to
$$
-\gm[34] \Vgs[34] - \left( -\gm[12] \frac{V_\mathrm{in}}{2} \right) - V_\mathrm{out} (\gds[2] + \gds[4] + s C_\mathrm{load}) = 0.
$$ {#eq-simple-ota-eq1}
 We further realize that
 $$
\Vgs[34] = -\gm[12] \frac{V_\mathrm{in}}{2} \frac{1}{\gm[34] + s \Cgs[34]}.
 $$ {#eq-simple-ota-eq2}

By combining @eq-simple-ota-eq1 and @eq-simple-ota-eq2 and after a bit of algebraic manipulation we arrive at
$$
A(s) = \frac{V_\mathrm{out}}{V_\mathrm{in}} = \frac{\gm[12]}{2} \frac{2 \gm[34] + s \Cgs[34]}{(\gm[34] + s \Cgs[34]) (\gds[2] + \gds[4] + s C_\mathrm{load})}.
$$ {#eq-simple-ota-gain}

When we now inspect @eq-simple-ota-gain we can see that for low frequencies the gain is
$$
A(s \rightarrow 0) = A_0 = \frac{\gm[12]}{\gds[2] + \gds[4]}
$$
which is plausible, and confirms the requirement of a high impedance at the output node. For very large frequencies we get
$$
A (s \rightarrow \infty) = \frac{\gm[12]}{2 s C_\mathrm{load}}
$$ {#eq-simple-ota-highf}
which is essentially the behaviour of an integrator, and we can use @eq-simple-ota-highf to calculate the frequency where the gain drops to $1$:
$$
f_\mathrm{ug} = \frac{\gm[12]}{4 \pi C_\mathrm{load}}
$$

when looking at @eq-simple-ota-gain we see that we have a dominant pole at $s_\mathrm{p}$ and a pole-zero doublet with $s_\mathrm{pd}$/$s_\mathrm{zd}$:
$$
s_\mathrm{p} = -\frac{\gds[2] + \gds[4]}{C_\mathrm{load}}
$$
$$
s_\mathrm{pd} = -\frac{\gm[34]}{\Cgs[34]}
$$
$$
s_\mathrm{zd} = -\frac{2 \gm[34]}{\Cgs[34]}
$$

#### OTA Noise

For the noise analysis we ignore the pole-zero doublet due to $\Cgs[34]$ (we assume minor impact due to this) and just consider the dominant pole. For the noise analysis at the output we set the input signal to zero, and thus we arrive at the simplified small-signal circuit shown in @fig-basic-ota-small-signal-noise.

{{< include figures/_fig_basic_ota_small_signal_noise.qmd >}}

We see that
$$
\overline{\Vgs[34]^2} = \frac{1}{\gm[34]^2} \left( \overline{I_\mathrm{n1}^2} + \overline{I_\mathrm{n3}^2} \right).
$$

::: {.callout-note}
Remember that **uncorrelated** noise quantities need to be power-summed (i.e., $I^2 = I_1^2 + I_2^2$)!
:::

We can then sum the output noise current $\overline{I_\mathrm{n}}$ as
$$
\overline{I_\mathrm{n}^2} = \overline{I_\mathrm{n2}^2} + \overline{I_\mathrm{n4}^2} + \gm[34]^2 \frac{1}{\gm[34]^2} \left( \overline{I_\mathrm{n1}^2} + \overline{I_\mathrm{n3}^2} \right) = 2 \left( \overline{I_\mathrm{n12}^2} + \overline{I_\mathrm{n34}^2} \right).
$$

As a next step, let us rewrite the OTA transfer function $A(s)$ (see @eq-simple-ota-gain) by getting rid of the pole-zero doublet as a simplyfing assumption to get
$$
A'(s) = \frac{\gm[12]}{\gds[2] + \gds[4] + s C_\mathrm{load}}.
$$ {#eq-simple-ota-gain-simplified}

Inspecting @eq-simple-ota-gain-simplified we can interpret the OTA transfer function as a transconductor $\gm[12]$ driving a load of $Y_\mathrm{load} = \gds[2] + \gds[4] + s C_\mathrm{load}$. We can thus redraw @fig-voltage-buffer-ota in the following way, injecting the previously calculated noise current into the output node. The result is shown in @fig-voltage-buffer-ota-noise.

{{< include figures/_fig_voltage_buffer_ota_noise.qmd >}}

We see that the feedback around the transconductor $\gm$ creates an impedance of $1/\gm$. We can now calculate the effective load conductance of
$$
Y'_\mathrm{load} = \gds[2] + \gds[4] + s C_\mathrm{load} + \gm \approx \gm + s C_\mathrm{load}.
$$

The output noise voltage is then
$$
\overline{V_\mathrm{n,out}^2}(s) = \frac{\overline{I_\mathrm{n}^2}}{|\gm + s C_\mathrm{load}|^2} = 
$$
